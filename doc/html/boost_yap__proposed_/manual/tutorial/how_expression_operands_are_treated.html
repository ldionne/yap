<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>How Expression Operands Are Treated</title>
<link rel="stylesheet" href="../../../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../../../index.html" title="Chapter&#160;1.&#160;Boost.YAP (Proposed)">
<link rel="up" href="../tutorial.html" title="Tutorial">
<link rel="prev" href="operator_macros.html" title="Operator Macros">
<link rel="next" href="customization_points.html" title="Customization Points">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="operator_macros.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../tutorial.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="customization_points.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="boost_yap__proposed_.manual.tutorial.how_expression_operands_are_treated"></a><a class="link" href="how_expression_operands_are_treated.html" title="How Expression Operands Are Treated">How
        Expression Operands Are Treated</a>
</h4></div></div></div>
<p>
          For any <code class="computeroutput"><a class="link" href="../../../boost/yap/expression.html" title="Struct template expression">expression&lt;&gt;</a></code> operator overload,
          or any function defined using one of the function definition macros, operands
          are treated in a uniform way.
        </p>
<p>
          The guiding design principle here is that an expression built using Boost.YAP
          should match the semantics of a builtin C++ expression as closely as possible.
          This implies that an rvalue remain treatable as a temporary (as it may
          in fact be) throughout the building and transformation of an expression,
          and that an lvalue should retain its connection to the underlying named
          entity to which it refers.
        </p>
<p>
          For example, if you see
        </p>
<pre class="programlisting"><span class="keyword">auto</span> <span class="identifier">expr</span> <span class="special">=</span> <span class="identifier">a</span> <span class="special">+</span> <span class="number">1</span><span class="special">;</span>
</pre>
<p>
          you should expect that <code class="computeroutput"><span class="identifier">a</span></code>
          will be an lvalue reference to some object of type <code class="computeroutput"><span class="keyword">decltype</span><span class="special">(</span><span class="identifier">a</span><span class="special">)</span></code>,
          regardless of whether <code class="computeroutput"><span class="identifier">a</span></code>
          is an <a class="link" href="../../concepts.html#boost_yap__proposed_.concepts.expression">Expression</a>
          or a builtin type. Similarly, you should expect the <code class="computeroutput"><span class="number">1</span></code>
          to be an rvalue, whether wrapped in a terminal or not.
        </p>
<p>
          Let's take a quick look at <code class="computeroutput"><a class="link" href="../../../boost/yap/make_te_idp140209129066264.html" title="Function template make_terminal">make_terminal()</a></code>.
          If you call it with a <code class="computeroutput"><span class="identifier">T</span></code>
          rvalue, the terminal's value type is a <code class="computeroutput"><span class="identifier">T</span></code>,
          and the rvalue gets moved into it. If you call it with a <code class="computeroutput"><span class="identifier">T</span> <span class="special">[</span><span class="keyword">const</span><span class="special">]</span></code> lvalue, the value type is <code class="computeroutput"><span class="identifier">T</span> <span class="special">[</span><span class="keyword">const</span><span class="special">]</span> <span class="special">&amp;</span></code>,
          and the reference refers to the lvalue (read <code class="computeroutput"><span class="special">[</span><span class="keyword">const</span><span class="special">]</span></code> as
          "possibly <code class="computeroutput"><span class="keyword">const</span></code>-qualified").
          This is important because you might write through the terminal later in
          an assignment operation. You don't want to lose the ability to do this,
          or be forced to write some Baroque pile of code to do so -- it should be
          natural and easy.
        </p>
<p>
          And it is:
        </p>
<p>
</p>
<pre class="programlisting"><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
<span class="keyword">auto</span> <span class="identifier">expr</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">yap</span><span class="special">::</span><span class="identifier">make_terminal</span><span class="special">(</span><span class="identifier">i</span><span class="special">)</span> <span class="special">=</span> <span class="number">42</span><span class="special">;</span>
<span class="identifier">evaluate</span><span class="special">(</span><span class="identifier">expr</span><span class="special">);</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span> <span class="comment">// Prints 42.</span>
</pre>
<p>
        </p>
<p>
          Now, there is a wrinkle. Boost.YAP's lazy expressions can be built piecemeal:
        </p>
<pre class="programlisting"><span class="keyword">auto</span> <span class="identifier">subexpr</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">yap</span><span class="special">::</span><span class="identifier">make_terminal</span><span class="special">(</span><span class="number">1</span><span class="special">)</span> <span class="special">+</span> <span class="number">2</span><span class="special">;</span>
<span class="comment">// This is fine, and acts more-or-less as if you wrote "1 / (1 + 2)".</span>
<span class="keyword">auto</span> <span class="identifier">expr</span> <span class="special">=</span> <span class="number">1</span> <span class="special">/</span> <span class="identifier">subexpr</span><span class="special">;</span>
</pre>
<p>
          whereas C++'s eager builtin expressions cannot:
        </p>
<pre class="programlisting"><span class="keyword">auto</span> <span class="identifier">subexpr</span> <span class="special">=</span> <span class="number">1</span> <span class="special">+</span> <span class="number">2</span><span class="special">;</span>    <span class="comment">// Same as "int subexpr = 3;".  Hm.</span>
<span class="keyword">auto</span> <span class="identifier">expr</span> <span class="special">=</span> <span class="number">1</span> <span class="special">/</span> <span class="identifier">subexpr</span><span class="special">;</span> <span class="comment">// Same as "int expr = 0;" Arg.</span>
</pre>
<p>
          Ok, so since you can build these lazy Boost.YAP expressions up from subexpressions,
          how do we treat the subexpressions? We treat them in exactly the same way
          as <code class="computeroutput"><a class="link" href="../../../boost/yap/make_te_idp140209129066264.html" title="Function template make_terminal">make_terminal()</a></code> treats its operands. Rvalues
          are moved in, and lvalues are captured by (possibly <code class="computeroutput"><span class="keyword">const</span></code>)
          reference.
        </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../../images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
            If you want to subvert the capture-by-reference semantics of using subexpressions,
            just <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">()</span></code>
            them. That will force a move -- or copy of values for which move is not
            defined.
          </p></td></tr>
</table></div>
<p>
          The capture-by-reference behavior is implemented via a special <code class="computeroutput"><a class="link" href="../../../boost/yap/expr_kind.html" title="Type expr_kind">expr_kind</a></code>,
          <a class="link" href="../../../boost/yap/expr_kind.html#boost.yap.expr_kind.expr_ref"><code class="computeroutput"><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span></code></a>.
          An <code class="computeroutput"><span class="identifier">expr_ref</span></code> expression
          has a single data element: a (possibly <code class="computeroutput"><span class="keyword">const</span></code>
          (Can I stop saying that every time? You get it, right? Ok, good.)) reference
          to an expression. This additional level of indirection causes some complications
          at times, as you can see in the examples. Fortunately, the complications
          are not overly cumbersome.
        </p>
<p>
          So, given the rules so far, here is a comprehensive breakdown of what happens
          when an operand is passed to a Boost.YAP operator. In this table, <code class="computeroutput"><span class="identifier">expr</span></code> is an <a class="link" href="../../concepts.html#boost_yap__proposed_.concepts.expressiontemplate">ExpressionTemplate</a>,
          and <code class="computeroutput"><span class="identifier">T</span></code> is a non-<a class="link" href="../../concepts.html#boost_yap__proposed_.concepts.expression">Expression</a>
          type. <code class="computeroutput"><span class="identifier">E</span></code> refers to any non-<code class="computeroutput"><span class="identifier">expr_ref</span></code> <a class="link" href="../../concepts.html#boost_yap__proposed_.concepts.expression">Expression</a>.
        </p>
<div class="table">
<a name="boost_yap__proposed_.manual.tutorial.how_expression_operands_are_treated.t0"></a><p class="title"><b>Table&#160;1.3.&#160;Operand Handling</b></p>
<div class="table-contents"><table class="table" summary="Operand Handling">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                  <p>
                    Operand
                  </p>
                </th>
<th>
                  <p>
                    Captured As
                  </p>
                </th>
<th>
                  <p>
                    Notes
                  </p>
                </th>
</tr></thead>
<tbody>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">T</span> <span class="keyword">const</span>
                    <span class="special">&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">terminal</span><span class="special">,</span>
                    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">hana</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">T</span> <span class="keyword">const</span>
                    <span class="special">&amp;&gt;&gt;</span></code>
                  </p>
                </td>
<td>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">T</span> <span class="special">&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">terminal</span><span class="special">,</span>
                    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">hana</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">T</span> <span class="special">&amp;&gt;&gt;</span></code>
                  </p>
                </td>
<td>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">T</span> <span class="special">&amp;&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">terminal</span><span class="special">,</span>
                    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">hana</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    Operand moved.
                  </p>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">E</span> <span class="keyword">const</span>
                    <span class="special">&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">hana</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">E</span> <span class="keyword">const</span>
                    <span class="special">&amp;&gt;&gt;</span></code>
                  </p>
                </td>
<td>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">E</span> <span class="special">&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">hana</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">E</span> <span class="special">&amp;&gt;&gt;</span></code>
                  </p>
                </td>
<td>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">E</span> <span class="special">&amp;&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">E</span></code>
                  </p>
                </td>
<td>
                  <p>
                    Operand moved.
                  </p>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="special">...&gt;</span> <span class="keyword">const</span>
                    <span class="special">&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="special">...&gt;</span></code>
                  </p>
                </td>
<td>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="special">...&gt;</span> <span class="special">&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="special">...&gt;</span></code>
                  </p>
                </td>
<td>
                </td>
</tr>
<tr>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="special">...&gt;</span> <span class="special">&amp;&amp;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    <code class="computeroutput"><span class="identifier">expr</span><span class="special">&lt;</span><span class="identifier">expr_kind</span><span class="special">::</span><span class="identifier">expr_ref</span><span class="special">,</span>
                    <span class="special">...&gt;</span></code>
                  </p>
                </td>
<td>
                  <p>
                    Operand moved.
                  </p>
                </td>
</tr>
</tbody>
</table></div>
</div>
<br class="table-break">
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2016 T. Zachary Laine<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="operator_macros.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../tutorial.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="customization_points.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
